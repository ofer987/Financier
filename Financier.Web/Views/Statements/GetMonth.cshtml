@model Financier.Web.ViewModels.Statement
@using Financier.Common.Extensions

<link href="~/css/site.css" rel="stylesheet">

<div>
  @Model.At.ToString("MMMM yyyy")
</div>

<!-- bar chart -->
<div class="charts">
  <h2>
    Assets
  </h2>
  <svg class="chart" id="asset-costs">
  </svg>
  <h2>
    Expenses
  </h2>
  <svg class="chart" id="expense-costs">
  </svg>
</div>

<link href="~/css/chart.css" rel="stylesheet">

<script src="~/js/apollo-client.min.js"></script>
<script src="~/js/d3.min.js">
</script>

<script type="text/javascript">
  'use strict';

  (function() {
    function request(year, month) {
      var client = new Apollo.lib.ApolloClient({
        networkInterface: Apollo.lib.createNetworkInterface({
          uri: '/graphql/statement',
          transportBatching: true,
        }),
        connectToDevTools: true,
      });

      client
        .query({
          query: Apollo.gql`
            {
              statement(
                year: ${year},
                month: ${month}
              ) {
                assetCosts {
                  tags {
                    name
                  }
                  amount
                }
                expenseCosts {
                  tags {
                    name
                  }
                  amount
                }
                assetAmountTotal
              }
            }
          `
        })
        .then(response => {

          var width = 960;
          var height = 500;
          new Chart(".charts #asset-costs", width, height)
            .render(response.data.statement.assetCosts);
          new Chart(".charts #expense-costs", width, height)
            .render(response.data.statement.expenseCosts);
        });
    }

    function Chart(selector, width, height) {
      this.margins = {
        top: 20,
        right: 30,
        bottom: 30,
        left: 40
      };

      this.selector = selector;
      this.width = width - this.margins.left - this.margins.right;
      this.height = height - this.margins.top - this.margins.bottom;

      this.scale = function(costs) {
        var amounts = costs
          .map(x => x.amount)

        return d3.scaleLinear()
          .range([this.height, 0])
          .domain([0, d3.max(amounts, d => d)]);
      };
    }

    Chart.prototype.render = function(costs) {
      var barWidth = this.width / costs.length;
      var barChart = d3.select(this.selector)
        .attr("width", this.width + this.margins.left + this.margins.right)
        .attr("height", (this.height + this.margins.top + this.margins.bottom));
      var scaledValues = this.scale(costs);

      var bar = barChart.selectAll("g")
          .data(costs)
        .enter().append("g")
        .attr("transform", (d, i) => { debugger; return `translate(${i * barWidth}, ${scaledValues(d.amount)})`; });

      bar.append("rect")
        .attr("y", d => { debugger; return scaledValues(d); })
        .attr("height", d => { debugger; return this.height - scaledValues(d.amount) })
        .attr("width", barWidth - 1);

      bar.append("text")
        .attr("x", barWidth / 2)
        .attr("y", d => scaledValues(d) + 3)
        .attr("dy", ".75em")
        .text(d => {
          var text = d.tags
            .map(tag => tag.name)
            .join(", ");

          return `${text} (${d.amount})`;
        });
    };

    request(2019, 4);
  })();
</script>

<div>
  <div>
    <h1>
      Assets:&nbsp;@(Model.GetAssetTotal())
    </h1>

    <h1>
      Expense:&nbsp;@(Model.GetExpenseTotal())
    </h1>

    <h1>
      Profit:&nbsp;@(Model.GetProfitTotal())
    </h1>
  </div>
  <div class="tag-costs">
    <h2>Assets</h2>
    @foreach (var tagCost in Model.AssetCosts.OrderBy(tc => tc.Amount))
    {
    <div class="flex-container">
      <div class="flex-item flex-tags">
        @(tagCost.Tags.Select(tag => tag.Name).Join(", "))
      </div>
      <div class="flex-item flex-amount">
        @((tagCost.Amount / Model.AssetAmountTotal).ToString("#0.00 %"))
      </div>
    </div>
    }
  </div>
  <div class="tag-costs">
    <h2>Expenses</h2>
    @foreach (var tagCost in Model.ExpenseCosts.OrderBy(tc => tc.Amount))
    {
    <div class="flex-container">
      <div class="flex-item flex-tags">
        @(tagCost.Tags.Select(tag => tag.Name).Join(", "))
      </div>
      <div class="flex-item flex-amount">
        @((tagCost.Amount / Model.ExpenseAmountTotal).ToString("#0.00 %"))
      </div>
    </div>
    }
  </div>
  <h2>Items</h2>
  @foreach (var item in Model.GetItems().OrderByDescending(item => item.Amount))
  {
    <div class="flex-container">
      <div class="flex-item flex-tags">
        @(item.Description)
      </div>
      <div class="flex-item flex-more-tags">
        @foreach (var tag in item.Tags)
        {
          <span>@(tag.Name)</span>
        }
      </div>
      <div class="flex-item flex-value">
        @(item.Amount)
      </div>
    </div>
  }
</div>
